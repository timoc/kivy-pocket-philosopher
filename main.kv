#:kivy 1.8.0
#:import main main
#:import get_random_color kivy.utils.get_random_color
#:import ListItemButton kivy.uix.listview.ListItemButton
#:import ListAdapter kivy.adapters.listadapter.ListAdapter

# DEBUG WIDGETS
#<Widget>:
#    canvas.after:
#        Line:
#            rectangle: self.x+1, self.y+1, self.width-1, self.height-1
#            dash_offset: 5
#            dash_length: 3

# DEBUG A WIDGET
#            canvas.after:
#                Color:
#                    rgba: 1, 0, 0, 0.5
#                Line:
#                    rectangle: self.x+1, self.y+1, self.width-1, self.height-1
#                Color:
#                    rgba: 0, 0, 1, 0.3
#                Rectangle:
#                    pos: self.pos
#                    size: self.size

<MyButton@Button>:
    halign: 'left'
    font_size: '16sp'
    font_name: 'assets/fonts/roboto/RobotoSlab-Bold.ttf'
    markup: True

<MyImage@Image>:
    pos: self.pos
    size: self.size
    auto_bring_to_front: False
    source: 'assets/img/pixel.png'
    keep_ratio: True
    allow_stretch: True
    canvas.before:
        Color:
            rgba: [.4, .4, .4, .3]
        Rectangle:
            texture: self.texture

<AboutWidget>:
    size_hint: 0.9, 0.9
    title: 'About'
    BoxLayout:
        orientation: "vertical"
        RstDocument:
            source: 'docs/ABOUT.rst'
        MyButton:
            size_hint_y: None
            text: 'OK'
            on_press: root.dismiss()

<HelpWidget>:
    size_hint: 0.9, 0.9
    title: 'Help'
    BoxLayout:
        orientation: "vertical"
        RstDocument:
            source: 'docs/HELP.rst'
        MyButton:
            size_hint_y: None
            text: 'OK'
            on_press: root.dismiss()

<MainActionBar@ActionBar>
    pos_hint: {'top':1}
    ActionView:
        use_separator: True
        ActionPrevious:
            with_previous: False
            on_press: app.Main.ids.Screens.current = 'Main'
        ActionButton:
            text: "Search"
            icon: 'assets/img/icons/search.png'
            on_press: app.Main.ids.Screens.current = 'Search'; app.Main.ids.SearchForm.ids.search_box.focus = True
        ActionButton:
            text: "New"
            icon: 'assets/img/icons/new.png'
            on_press: root.new()
        ActionButton:
            id: btn_settings
            text: "Settings"
            icon: 'assets/img/icons/settings.png'
            on_press: app.open_settings()
        ActionOverflow:
            ActionButton:
                text: "Help"
                icon: 'assets/img/icons/help.png'
                on_press: root.help()
            ActionButton:
                text: "About"
                icon: 'assets/img/icons/about.png'
                on_press: root.about()
            ActionButton:
                icon: 'assets/img/icons/quit.png'
                text: "Exit"
                on_press: app.stop()

<AphorismWidget@BoxLayout>:
    BoxLayout:
        orientation: "vertical"
        RelativeLayout:
            MyImage:
                id: background
            Scatter:
                size_hint: None, None
                size: quote.size
                Label:
                    id: quote
                    text_size: root.width, None
                    size: self.texture_size
                    padding: ('20dp', '20dp')
                    valign: 'middle'
                    font_name: 'assets/fonts/roboto/RobotoSlab-Bold.ttf'
                    font_size: '30sp'
                    markup: True
                    canvas.before:
                        Color:
                            rgba: get_random_color(0.5)
                        Rectangle:
                            pos: self.pos
                            size: self.size

<SearchInputWidget>:
    focus: True
    multiline: False

<SearchForm>:
    search_input: search_box
    search_results: search_results_list
    BoxLayout:
        orientation: "vertical"
        BoxLayout:
            orientation: "horizontal"
            size_hint_y: None
            size: (self.parent.width, '36dp')
            Image:
                size_hint_x: None
                width: '32dp'
                height: root.height
                keep_ratio: True
                allow_stretch: True
                source: 'assets/img/icons/search.png'
            SearchInputWidget:
                id: search_box
            MyButton:
                id: search_submit
                size_hint_x: None
                width: '64dp'
                text: 'Go!'
                on_press: root.action_search(text = search_box.text)
        ListView:
            id: search_results_list
            adapter:
                ListAdapter(
                data = [],
                args_converter = root.args_converter,
                cls = main.SearchResultsButton)

<SearchResultsButton@MyButton>:
    size_hint_y: None
    height: '64dp'
    halign: 'left'
    font_size: '16sp'
    text: "{}".format(self.aphorism[1])
    markup: False
    on_press: app.root.aphorism_display_by_id(self.aphorism[0])

<FormLabel@Label>
    size_hint_y: None
    size: (self.parent.width, '36dp')
    text_size: self.parent.width, None
    halign: 'left'
    valign: 'middle'
    markup: False

<FormTextInput@TextInput>
    size_hint_y: None
    size: (self.parent.width, '36dp')
    multiline: False
    focus: True

<FormTextArea@FormTextInput>:
    multiline: True

<NewFormWidget@Popup>:
    size_hint: 0.8, 0.8
    auto_dismiss: False
    title: 'Add New Aphorism'
    BoxLayout:
        orientation: "vertical"
        padding: 3
        BoxLayout:
            id: new_form
            orientation: "vertical"
            FormLabel:
                text: 'Author:'
            FormTextInput:
                id: new_author
            FormLabel:
                text: 'Source:'
            FormTextInput:
                id: new_source
            BoxLayout:
                orientation: "vertical"
                FormLabel:
                    text: 'Aphorism:'
                FormTextArea:
                    id: new_aphorism
                    size_hint_y: 0.8
                FormLabel:
                    text: 'Tags:'
                FormTextArea:
                    id: new_tags
                    size_hint_y: 0.2
                    size: (self.parent.width, '72dp')
        BoxLayout:
            size_hint_y: 0.1
            MyButton:
                id: submit_new_aphorism
                size_hint_x: 0.7
                text: 'Add New Aphorism'
                on_press: root.action_new()
            MyButton:
                id: submit_new_aphorism
                size_hint_x: 0.3
                text: 'Cancel'
                on_press: root.action_cancel()

<Main>:
    search_results: []
    AnchorLayout:
        anchor_x: 'center'
        anchor_y: 'top'
        ScreenManager:
            size_hint: 1, 1
            id: Screens
            Screen:
                name: 'Main'
                BoxLayout:
                    orientation: "vertical"
                    MainActionBar:
                        size_hint_y: None
                    BoxLayout:
                        id: aphorism_container
                        orientation: "vertical"
                        AphorismWidget:
                    MyButton:
                        size_hint_y: None
                        height: '64dp'
                        font_size: '20sp'
                        text: 'Random'
                        on_press: root.aphorism_random_display()
            Screen:
                name: 'Search'
                orientation: "vertical"
                BoxLayout:
                    orientation: "vertical"
                    MainActionBar:
                    SearchForm:
                        id: SearchForm
            Screen:
                name: 'List'
                BoxLayout:
                    orientation: "vertical"
                    MainActionBar:
                    BoxLayout:
                        orientation: "vertical"
                        RelativeLayout:
